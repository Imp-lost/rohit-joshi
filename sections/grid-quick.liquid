{% comment %}
  Product Grid Section with Quick View
{% endcomment %}

<div class="product-grid-section" data-section-id="{{ section.id }}">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Lustria:wght@400&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600&display=swap');
    .product-grid-container {
      max-width: 1300px;
      margin: 0 auto;
      padding: 20px;
    }

    .section-heading {
      text-align: left;
      margin-bottom: 20px;
    }

    .heading-text {
      font-family: Lustria, serif;
      font-weight: 400;
      font-style: normal;
      font-size: 36px;
      line-height: 120%;
      letter-spacing: 0px;
      vertical-align: middle;
      margin: 0 0 10px 0;
      color: #333;
    }

    .subheading-text {
      font-size: 1.1rem;
      color: #666;
      margin: 0;
      max-width: 600px;
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      .heading-text {
        font-size: 24px;
      }
      
      .subheading-text {
        font-size: 1rem;
      }
      
      .section-heading {
        margin-bottom: 20px;
      }
    }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 40px;
    }

    @media (max-width: 768px) {
      .product-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
    }

    .product-item {
      position: relative;
      overflow: hidden;
      cursor: pointer;
      aspect-ratio: 1 / 1;
    }

    .product-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .product-overlay {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
    }

    .quick-view-btn {
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
      padding: 8px;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      background: none;
    }

    .quick-view-btn img {
      width: 20px;
      height: 20px;
    }

    /* Quick View Modal */
    .quick-view-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }

    .quick-view-modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 0;
      max-width: 350px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      scrollbar-width: none;
      -ms-overflow-style: none;
      font-family: 'Jost', sans-serif;
    }

    .modal-header {
      position: relative;
      padding: 24px;
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .modal-product-image {
      width: 120px;
      height: 140px;
      object-fit: cover;
      display: block;
      flex-shrink: 0;
    }

    .modal-info {
      flex: 1;
      min-width: 0;
    }

    .close-modal {
      position: absolute;
      top: 12.7px;
      right: 12.7px;
      background: none;
      border: none;
      width: 12px;
      height: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      color: #333;
      transform: rotate(45deg);
      z-index: 1;
    }

    .modal-product-title {
      font-size: 16px;
      font-weight: 500;
      margin: 0 0 8px 0;
      color: #333;
      line-height: 1.3;
      font-family: 'Jost', sans-serif;
    }

    .modal-product-price {
      font-size: 16px;
      font-weight: 600;
      color: #000;
      margin-bottom: 8px;
      font-family: 'Jost', sans-serif;
    }

    .modal-product-description {
      color: #666;
      line-height: 1.5;
      {% comment %} margin-bottom: 20px; {% endcomment %}
      font-size: 14px;
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: 'Jost', sans-serif;
    }

    .modal-body {
      padding: 0 24px 24px 24px;
    }

    .variant-group {
      margin-bottom: 20px;
    }

    .variant-label {
      font-weight: 500;
      margin-bottom: 8px;
      display: block;
      color: #333;
      font-size: 14px;
      font-family: 'Jost', sans-serif;
    }

    .variant-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      border: 1px solid #ddd;
    }

    .variant-option {
      padding: 12px 16px;
      border: none;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      text-align: center;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: 'Jost', sans-serif;
    }

    .variant-option:not(:last-child) {
      border-right: 1px solid #ddd;
    }

    .variant-option:hover {
      background: #f5f5f5;
    }

    .variant-option.selected {
      background: #000;
      color: white;
    }

    .variant-color-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: inline-block;
      border: 1px solid #ddd;
    }

    .variant-option.selected .variant-color-dot {
      border-color: white;
    }

    .size-dropdown {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #ddd;
      font-size: 14px;
      background: white;
      cursor: pointer;
      appearance: none;
      background-image: url('{{ "dropdown-arrow.svg" | asset_url }}');
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 40px;
      font-family: 'Jost', sans-serif;
    }

    .size-dropdown:focus {
      outline: none;
      border-color: #333;
    }

    .size-dropdown option {
      padding: 8px;
    }

    .add-to-cart-btn {
      width: 100%;
      background: #000;
      color: white;
      border: none;
      padding: 14px 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      margin-top: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      letter-spacing: 0.5px;
      font-family: 'Jost', sans-serif;
    }

    .add-to-cart-btn:hover {
      background: #333;
    }

    .add-to-cart-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .loading {
      opacity: 0.7;
      cursor: wait;
    }

    @media (max-width: 768px) {
      .modal-content {
        max-width: 95%;
        max-height: 95vh;
      }
      
      .modal-header {
        flex-direction: column;
        padding: 20px;
      }
      
      .modal-product-image {
        width: 100%;
        height: 200px;
        align-self: center;
      }
      
      .modal-body {
        padding: 0 20px 20px 20px;
      }
    }
  </style>

  <div class="product-grid-container">
    {% if section.settings.heading != blank %}
      <div class="section-heading">
        <h2 class="heading-text">{{ section.settings.heading }}</h2>
        {% if section.settings.subheading != blank %}
          <p class="subheading-text">{{ section.settings.subheading }}</p>
        {% endif %}
      </div>
    {% endif %}
    
    <div class="product-grid">
      {% for product in section.settings.collection.products limit: 6 %}
        <div class="product-item" data-product-id="{{ product.id }}">
          <img 
            src="{{ product.featured_image | image_url: width: 400 }}" 
            alt="{{ product.title }}"
            class="product-image"
            width="400"
            height="400"
            loading="lazy"
          >
          <div class="product-overlay">
            <button class="quick-view-btn" onclick="openQuickView({{ product.id }})">
              <img src="{{ 'openmodal.svg' | asset_url }}" alt="Quick View" width="24" height="24">
            </button>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Quick View Modal -->
  <div id="quickViewModal" class="quick-view-modal">
    <div class="modal-content">
      <button class="close-modal" onclick="closeQuickView()">
        <img src="{{ 'openmodal.svg' | asset_url }}" alt="Close" width="18" height="18">
      </button>
      
      <div class="modal-header">
        <img id="modalImage" class="modal-product-image" width="120" height="140">
        <div class="modal-info">
          <h2 id="modalTitle" class="modal-product-title"></h2>
          <div id="modalPrice" class="modal-product-price"></div>
          <div id="modalDescription" class="modal-product-description"></div>
        </div>
      </div>
      
      <div class="modal-body">
        <form id="addToCartForm">
          <div id="variantOptions"></div>
          <button type="submit" class="add-to-cart-btn" id="addToCartBtn">
            <span>ADD TO CART</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m9 18 6-6-6-6"/>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>

 <script>
    // Product data storage
    const productData = {};
    
    {% for product in section.settings.collection.products limit: 9 %}
      productData[{{ product.id }}] = {
        id: {{ product.id }},
        title: {{ product.title | json }},
        price: {{ product.price | json }},
        comparePrice: {{ product.compare_at_price | json }},
        description: {{ product.description | strip_html | json }},
        image: {{ product.featured_image | image_url: width: 500 | json }},
        variants: [
          {% for variant in product.variants %}
            {
              id: {{ variant.id }},
              title: {{ variant.title | json }},
              price: {{ variant.price | json }},
              available: {{ variant.available | json }},
              option1: {{ variant.option1 | json }},
              option2: {{ variant.option2 | json }},
              option3: {{ variant.option3 | json }}
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ],
        options: [
          {% for option in product.options_with_values %}
            {
              name: {{ option.name | json }},
              position: {{ option.position }},
              values: {{ option.values | json }}
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ]
      };
    {% endfor %}

    let currentProduct = null;
    let selectedVariant = null;

    // Enhanced color mapping with dynamic detection
    const colorMap = {
      // Basic colors
      'Black': '#000000',
      'White': '#FFFFFF',
      'Blue': '#0066CC',
      'Red': '#CC0000',
      'Green': '#00CC00',
      'Yellow': '#FFFF00',
      'Purple': '#6600CC',
      'Pink': '#FF69B4',
      'Orange': '#FF6600',
      'Brown': '#8B4513',
      'Gray': '#808080',
      'Grey': '#808080',
      
      // Extended color variations
      'Navy': '#000080',
      'Light Blue': '#87CEEB',
      'Dark Blue': '#00008B',
      'Sky Blue': '#87CEEB',
      'Royal Blue': '#4169E1',
      
      'Light Green': '#90EE90',
      'Dark Green': '#006400',
      'Forest Green': '#228B22',
      'Olive': '#808000',
      'Lime': '#00FF00',
      
      'Light Gray': '#D3D3D3',
      'Dark Gray': '#A9A9A9',
      'Silver': '#C0C0C0',
      'Charcoal': '#36454F',
      'Slate': '#708090',
      
      'Burgundy': '#800020',
      'Maroon': '#800000',
      'Crimson': '#DC143C',
      'Rose': '#FF007F',
      'Coral': '#FF7F50',
      
      'Beige': '#F5F5DC',
      'Cream': '#FFFDD0',
      'Ivory': '#FFFFF0',
      'Tan': '#D2B48C',
      'Khaki': '#F0E68C',
      
      'Gold': '#FFD700',
      'Bronze': '#CD7F32',
      'Copper': '#B87333',
      
      'Lavender': '#E6E6FA',
      'Violet': '#EE82EE',
      'Indigo': '#4B0082',
      'Magenta': '#FF00FF',
      
      'Turquoise': '#40E0D0',
      'Teal': '#008080',
      'Cyan': '#00FFFF',
      'Mint': '#98FB98',
      
      'Peach': '#FFCBA4',
      'Salmon': '#FA8072',
      'Mustard': '#FFDB58',
      'Rust': '#B7410E'
    };

    // Dynamic color detection function
    function getVariantColor(colorValue) {
      // First try exact match from colorMap
      if (colorMap[colorValue]) {
        return colorMap[colorValue];
      }
      
      // Try case-insensitive match
      const exactMatch = Object.keys(colorMap).find(
        key => key.toLowerCase() === colorValue.toLowerCase()
      );
      if (exactMatch) {
        return colorMap[exactMatch];
      }
      
      // Try partial match (for compound color names like "Light Blue Denim")
      const partialMatch = Object.keys(colorMap).find(
        key => colorValue.toLowerCase().includes(key.toLowerCase()) || 
               key.toLowerCase().includes(colorValue.toLowerCase())
      );
      if (partialMatch) {
        return colorMap[partialMatch];
      }
      
      // Generate color based on string hash (fallback for unknown colors)
      return generateColorFromString(colorValue);
    }

    // Generate a color based on string hash for unknown color names
    function generateColorFromString(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      
      // Convert to RGB while avoiding too light colors
      const r = Math.max(50, (hash & 0xFF0000) >> 16);
      const g = Math.max(50, (hash & 0x00FF00) >> 8);
      const b = Math.max(50, hash & 0x0000FF);
      
      return `rgb(${r}, ${g}, ${b})`;
    }

    function openQuickView(productId) {
      currentProduct = productData[productId];
      if (!currentProduct) return;

      // Populate modal content
      const modalImage = document.getElementById('modalImage');
      modalImage.src = currentProduct.image;
      modalImage.alt = currentProduct.title;
      
      document.getElementById('modalTitle').textContent = currentProduct.title;
      document.getElementById('modalDescription').textContent = currentProduct.description;
      
      // Set initial variant and price
      selectedVariant = currentProduct.variants[0];
      updatePrice();
      
      // Build variant options
      buildVariantOptions();
      
      // Show modal
      document.getElementById('quickViewModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeQuickView() {
      document.getElementById('quickViewModal').classList.remove('active');
      document.body.style.overflow = '';
      currentProduct = null;
      selectedVariant = null;
    }

    function updatePrice() {
      const priceElement = document.getElementById('modalPrice');
      if (selectedVariant) {
        priceElement.textContent = formatMoney(selectedVariant.price);
      } else {
        priceElement.textContent = formatMoney(currentProduct.price);
      }
    }

    // Updated buildVariantOptions with color first, size last, and dynamic colors
    function buildVariantOptions() {
      const container = document.getElementById('variantOptions');
      container.innerHTML = '';

      if (!currentProduct.options || currentProduct.options.length === 0) return;

      // Sort options: Color first, Size last, others in between
      const sortedOptions = [...currentProduct.options].sort((a, b) => {
        const aName = a.name.toLowerCase();
        const bName = b.name.toLowerCase();
        
        // Color should come first
        if (aName === 'color' || aName === 'colour') return -1;
        if (bName === 'color' || bName === 'colour') return 1;
        
        // Size should come last
        if (aName === 'size') return 1;
        if (bName === 'size') return -1;
        
        // Keep original order for other options
        return a.position - b.position;
      });

      sortedOptions.forEach((option, sortedIndex) => {
        // Find the original index for this option
        const originalIndex = currentProduct.options.findIndex(opt => opt.name === option.name);
        
        const variantGroup = document.createElement('div');
        variantGroup.className = 'variant-group';
        
        const label = document.createElement('label');
        label.className = 'variant-label';
        label.textContent = option.name;
        variantGroup.appendChild(label);

        if (option.name.toLowerCase() === 'size') {
          // Create dropdown for size
          const select = document.createElement('select');
          select.className = 'size-dropdown';
          select.addEventListener('change', (e) => updateVariant(originalIndex, e.target.value));
          
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = 'Choose your size';
          select.appendChild(defaultOption);
          
          option.values.forEach(value => {
            const optionElement = document.createElement('option');
            optionElement.value = value;
            optionElement.textContent = value;
            select.appendChild(optionElement);
          });
          
          variantGroup.appendChild(select);
        } else {
          // Create button grid for other options (like color)
          const optionsContainer = document.createElement('div');
          optionsContainer.className = 'variant-options';
          
          option.values.forEach(value => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'variant-option';
            
            // Add color dot if this is a color option with dynamic color detection
            if (option.name.toLowerCase() === 'color' || option.name.toLowerCase() === 'colour') {
              const colorDot = document.createElement('span');
              colorDot.className = 'variant-color-dot';
              
              // Use dynamic color detection
              const detectedColor = getVariantColor(value);
              colorDot.style.backgroundColor = detectedColor;
              
              // Add border for light colors
              if (value.toLowerCase() === 'white' || 
                  value.toLowerCase() === 'cream' || 
                  value.toLowerCase() === 'ivory' ||
                  value.toLowerCase() === 'beige') {
                colorDot.style.border = '1px solid #ddd';
              }
              
              button.appendChild(colorDot);
            }
            
            const textSpan = document.createElement('span');
            textSpan.textContent = value;
            button.appendChild(textSpan);
            
            button.addEventListener('click', () => {
              // Remove selected class from siblings
              optionsContainer.querySelectorAll('.variant-option').forEach(btn => {
                btn.classList.remove('selected');
              });
              // Add selected class to clicked button
              button.classList.add('selected');
              updateVariant(originalIndex, value);
            });
            
            // Select first option by default
            if (value === option.values[0]) {
              button.classList.add('selected');
            }
            
            optionsContainer.appendChild(button);
          });
          
          variantGroup.appendChild(optionsContainer);
        }
        
        container.appendChild(variantGroup);
      });
    }

    function updateVariant(optionIndex, value) {
      // Get current selections
      const selections = [];
      currentProduct.options.forEach((option, index) => {
        if (index === optionIndex) {
          selections[index] = value;
        } else if (option.name.toLowerCase() === 'size') {
          const select = document.querySelector('.size-dropdown');
          selections[index] = select.value;
        } else {
          const selected = document.querySelector(`#variantOptions .variant-group:nth-child(${index + 1}) .variant-option.selected`);
          selections[index] = selected ? selected.textContent.trim() : option.values[0];
        }
      });

      // Find matching variant
      selectedVariant = currentProduct.variants.find(variant => {
        return selections.every((selection, index) => {
          const variantOption = variant[`option${index + 1}`];
          return !selection || variantOption === selection;
        });
      });

      if (!selectedVariant) {
        selectedVariant = currentProduct.variants[0];
      }

      updatePrice();
      updateAddToCartButton();
    }

    function updateAddToCartButton() {
      const button = document.getElementById('addToCartBtn');
      if (selectedVariant && selectedVariant.available) {
        button.disabled = false;
        button.querySelector('span').textContent = 'ADD TO CART';
      } else {
        button.disabled = true;
        button.querySelector('span').textContent = 'SOLD OUT';
      }
    }

    function formatMoney(cents) {
      return (cents / 100).toFixed(2) + '€';
    }

    // Add to cart functionality
    document.getElementById('addToCartForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!selectedVariant || !selectedVariant.available) return;

      const button = document.getElementById('addToCartBtn');
      const originalText = button.querySelector('span').textContent;
      
      // Show loading state
      button.classList.add('loading');
      button.querySelector('span').textContent = 'ADDING...';
      button.disabled = true;

      try {
        // Add main product to cart
        await addToCart(selectedVariant.id, 1);
        
        // Check if we need to add the "Soft Winter Jacket" automatically
        const needsJacket = checkForAutomaticJacket();
        if (needsJacket) {
          await addSoftWinterJacket();
        }
        
        button.querySelector('span').textContent = 'ADDED!';
        setTimeout(() => {
          closeQuickView();
        }, 1000);
        
      } catch (error) {
        console.error('Error adding to cart:', error);
        button.querySelector('span').textContent = 'ERROR';
        setTimeout(() => {
          button.querySelector('span').textContent = originalText;
          button.disabled = false;
        }, 2000);
      } finally {
        button.classList.remove('loading');
      }
    });

    function checkForAutomaticJacket() {
      // Check if selected variant has Black color and Medium size
      const hasBlack = selectedVariant.option1 === 'Black' || selectedVariant.option2 === 'Black' || selectedVariant.option3 === 'Black';
      const hasMedium = selectedVariant.option1 === 'Medium' || selectedVariant.option2 === 'Medium' || selectedVariant.option3 === 'Medium';
      
      return hasBlack && hasMedium;
    }

    async function addSoftWinterJacket() {
      // You'll need to replace this with the actual variant ID of the "Soft Winter Jacket"
      // This is a placeholder - you should set this to the correct variant ID
      const jacketVariantId = 'YOUR_JACKET_VARIANT_ID_HERE';
      
      try {
        await addToCart(jacketVariantId, 1);
        console.log('Soft Winter Jacket added automatically');
      } catch (error) {
        console.error('Failed to add Soft Winter Jacket:', error);
      }
    }

    async function addToCart(variantId, quantity) {
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: variantId,
          quantity: quantity
        })
      });

      if (!response.ok) {
        throw new Error('Failed to add to cart');
      }

      return response.json();
    }

    // Close modal when clicking outside
    document.getElementById('quickViewModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeQuickView();
      }
    });

    // Close modal with escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeQuickView();
      }
    });
  </script>
</div>

{% schema %}
{
  "name": "Quick View",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Featured Products"
    },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "Section Subheading",
      "info": "Optional description text below the heading"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Select the collection to display products from"
    }
  ],
  "presets": [
    {
      "name": "Product Grid with Quick View",
      "settings": {
        "heading": "Featured Products",
        "subheading": "Discover our curated selection of premium products"
      }
    }
  ]
}
{% endschema %}